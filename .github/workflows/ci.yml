name: CI


on:
pull_request:
branches: [main]
push:
branches: [main]


jobs:
build:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v4


- name: Setup Node
uses: actions/setup-node@v4
with:
node-version: '20'
cache: 'npm'


- name: Install deps
run: npm ci


- name: Typecheck
run: npm run typecheck


- name: Lint
run: npm run lint


- name: Test
run: npm run test


- name: Next build (sanity)
run: npm run build


vercel-preview-validate:
if: github.event_name == 'pull_request'
runs-on: ubuntu-latest
needs: build
steps:
- name: Checkout
uses: actions/checkout@v4


- name: Setup Node
uses: actions/setup-node@v4
with:
node-version: '20'
cache: 'npm'


- name: Install deps
run: npm ci


- name: Pull Vercel env (preview)
run: npm run vercel:pull:preview
env:
VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}


- name: Validate Vercel preview build
run: npm run vercel:build:preview
env:
VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}